{% extends 'displayers.html' %}
{% block title %}<title>Quiz View</title>{% endblock %}
{% block css %}
    {% load static %}
        <link rel="stylesheet" type="text/css" href="{% static 'css/quiz.css' %}">
{% endblock %}
{% block body %}
    <script type="text/javascript">
        let idDict = {};
        idDict.totalPageLeaveNo = setInterval(function() {
            randomChangeNumber(document.getElementById("total-page-leavers-no"));
        }, 50);
        idDict.totalUniquePageLeaversNo = setInterval(function() {
            randomChangeNumber(document.getElementById("total-page-leaves-no"));
        }, 50);
        idDict.std = setInterval(function () {
            randomChangeNumber(document.getElementById("std-no"), true);
        }, 50);
        idDict.stdAbove = setInterval(function () {
            randomChangeNumber(document.getElementById("std-above-no"));
        }, 50);

        $.ajax({
            "url": "{% url 'canvaswrapper:quiz-get-stats' %}",
            "method": "GET",
            "dataType": "json",
            "data": {"course_id": {{ course_id }}, "quiz_id": {{ quiz_id }}},
            success: function (results) {
                console.log(results);
                loadStats(results);
            },
            error: function(results) {
                // TODO: Fail Case
                console.log(results);
            }
        });

        function randomChangeNumber(element, percent=false) {
            if (percent) {
                element.innerText = Math.floor(Math.random() * Math.floor(100)) + "%";
            }
            else {
                element.innerText = Math.floor(Math.random() * Math.floor(100));
            }
        }

        function genericP(text, parent) {
            let newGenericP = document.createElement("p");
            newGenericP.className = "generic-p";
            newGenericP.innerText = text;
            newGenericP.style.opacity = "0";
            parent.appendChild(newGenericP);
            return newGenericP;
        }


        function loadStats(results) {
            results = JSON.parse(results["success"]["data"]);
            clearInterval(idDict.std);
            document.getElementById("std-no").innerText = Math.round(results["std"] * 100) + "%";

            clearInterval(idDict.stdAbove);
            document.getElementById("std-above-no").innerText = results["no_above_2_std"];
            let twoAbove = document.createElement("b");
            twoAbove.innerText = "(" + Math.round(results["std"] * 200) + "%)";
            let stdAboveDesc = document.getElementById("std-above-desc");
            stdAboveDesc.appendChild(document.createElement("br"));
            document.getElementById("std-above-desc").appendChild(twoAbove);


            //TODO Indicate that more statistics are loading.
            getMoreStatistics();
        }

        function getMoreStatistics() {
            $.ajax({
                url: "{% url 'canvaswrapper:quiz-get-submissions'%}",
                method: "GET",
                dataType: "json",
                data: {"course_id": {{ course_id }}, "quiz_id": {{ quiz_id }}},
                success: function(results) {
                    console.log(results);
                    loadMoreStatistics(results["success"]["data"]);
                },
                error: function(results) {
                    // TODO: Fail Case
                    console.log(results);
                }
            });
        }

        function loadMoreStatistics(results) {

            clearInterval(idDict.totalPageLeaveNo);
            document.getElementById("total-page-leaves-no").innerText = results["page_leaves"];

            clearInterval(idDict.totalUniquePageLeaversNo);
            document.getElementById("total-page-leavers-no").innerText = results["unique_page_leavers"];
        }

    </script>

    <button>Check For Cheaters</button>
    <div id="title"></div>
    <div id="submissions"></div>
    <div id="statistics">
        <h1>Important Statistics</h1>
        <div id="std-div">
            <p class="number" id="std-no">0</p>
            <p class="text">Standard Deviation</p>
        </div>

        <div id="std-no-div">
            <p class="number" id="std-above-no">0</p>
            <p class="text" id="std-above-desc">Student(s) above or at 2 standard deviations</p>
        </div>

        <div id="total-page-leaves">
            <p class="number" id="total-page-leaves-no">0</p>
            <p class="text">Total Page Leave(s)</p>
        </div>

        <div id="total-page-leavers">
            <p class="number" id="total-page-leavers-no">0</p>
            <p class="text text-last">Student(s) left the page at least once during the test</p>
        </div>
    </div>

{% endblock %}